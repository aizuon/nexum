name: CI

on:
  push:
    branches: [main, feature/aws-e2e-tests]

jobs:
  e2e-tests-aws:
    name: E2E Tests (AWS)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Publish E2E Server (linux-arm64)
        run: |
          dotnet publish Nexum.E2E.Server/Nexum.E2E.Server.csproj \
            --configuration Release \
            --runtime linux-arm64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            --output ./publish/server

      - name: Publish E2E Client (linux-arm64)
        run: |
          dotnet publish Nexum.E2E.Client/Nexum.E2E.Client.csproj \
            --configuration Release \
            --runtime linux-arm64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            --output ./publish/client

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create S3 bucket if not exists
        run: |
          if aws s3api head-bucket --bucket nexum-e2e-artifacts 2>/dev/null; then
            echo "Bucket already exists"
          elif [ "${{ secrets.AWS_REGION }}" = "us-east-1" ]; then
            aws s3api create-bucket --bucket nexum-e2e-artifacts --region us-east-1
          else
            aws s3api create-bucket --bucket nexum-e2e-artifacts --region ${{ secrets.AWS_REGION }} \
              --create-bucket-configuration LocationConstraint=${{ secrets.AWS_REGION }}
          fi

      - name: Upload E2E binaries to S3
        run: |
          aws s3 cp ./publish/server/Nexum.E2E.Server s3://nexum-e2e-artifacts/e2e-server/Nexum.E2E.Server
          aws s3 cp ./publish/client/Nexum.E2E.Client s3://nexum-e2e-artifacts/e2e-client/Nexum.E2E.Client

      - name: Run E2E Tests
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          dotnet test Nexum.Tests.E2E/Nexum.Tests.E2E.csproj \
            --configuration Release \
            --no-build \
            --logger "trx;LogFileName=e2e-tests.trx" \
            --results-directory ./TestResults \
            -- xUnit.ReporterSwitch=verbose

      - name: Upload E2E Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: ./TestResults/*.trx
          retention-days: 7

      - name: Cleanup AWS Resources (on failure)
        if: failure()
        run: |
          INSTANCE_IDS=$(aws ec2 describe-instances \
            --filters "Name=tag:nexum-e2e,Values=true" "Name=instance-state-name,Values=pending,running,stopping,stopped" \
            --query "Reservations[].Instances[].InstanceId" \
            --output text)
          
          if [ -n "$INSTANCE_IDS" ]; then
            echo "Terminating instances: $INSTANCE_IDS"
            aws ec2 terminate-instances --instance-ids $INSTANCE_IDS
            aws ec2 wait instance-terminated --instance-ids $INSTANCE_IDS
          fi
          
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=nexum-e2e-sg" \
            --query "SecurityGroups[].GroupId" \
            --output text)
          
          if [ -n "$SG_ID" ]; then
            echo "Deleting security group: $SG_ID"
            aws ec2 delete-security-group --group-id $SG_ID || true
          fi
          
          aws iam remove-role-from-instance-profile --instance-profile-name nexum-e2e-instance-profile --role-name nexum-e2e-instance-role || true
          aws iam delete-instance-profile --instance-profile-name nexum-e2e-instance-profile || true
          aws iam detach-role-policy --role-name nexum-e2e-instance-role --policy-arn arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore || true
          aws iam delete-role --role-name nexum-e2e-instance-role || true

